name: Build & Deploy to TimeWeb

on:
  push: # пуш из любой ветки
  workflow_dispatch:

env:
  # переменные
  appName: mlops-app
  imageTag : mlops-app-${{ github.ref_name }}-${{ github.sha }} 
  archiveName : mlops-app-${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # === Этап 1: Тесты (на хосте, без Docker) ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install test dependencies
        run: |
          pip install -r mlops/requirements.txt
          pip install pytest

      - name: Run tests
        run: pytest mlops/tests/test_app.py

      # === Этап 2: Сборка Docker-образа ===
      - name: Build Docker image
        run: |
          docker build \
            --file configs/docker/Dockerfile \
            --tag ${{ env.imageTag }} \
            .

      # === Этап 3: Подготовка SSH ===
      - name: Setup SSH key
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # === Этап 4: Сохранение образа и отправка на сервер ===
      - name: Save and compress Docker image
        run: |
          docker save ${{ env.imageTag }} | gzip > /tmp/${{ env.archiveName }}.tar.gz

      - name: Copy image to server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          USER: ${{ secrets.SERVER_USER }}
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            /tmp/${{ env.archiveName }}.tar.gz \
            $USER@$SERVER_IP:/tmp/

      # === Этап 5: Запуск на сервере (загрузка + запуск контейнера) ===
      - name: Load image and run container on server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          USER: ${{ secrets.SERVER_USER }}
          SHA: ${{ github.sha }}
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $USER@$SERVER_IP "
            # Загрузить образ
            docker load < /tmp/${{ env.archiveName }}.tar.gz &&

            # Остановить и удалить старый контейнер (если есть)
            docker stop mlops-app 2>/dev/null || true &&
            docker rm mlops-app 2>/dev/null || true &&

            # Запустить новый
            docker run -d \
              --name mlops-app \
              --restart unless-stopped \
              -p 8000:8000 \
              mlops-app:$SHA
            
            rm -f /tmp/mlops-app.tar.gz
          "
          

      - name: Cleanup (optional)
        run: echo "✅ Deployed mlops-app:${{ github.sha }} at $(date)"