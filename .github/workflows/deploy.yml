name: Build & Deploy to TimeWeb

on:
  push:
  workflow_dispatch:

env:
  APP_NAME: mlops-app
  IMAGE_TAG: mlops-app-${{ github.ref_name }}-${{ github.sha }}
  ARCHIVE_NAME: mlops-app-${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # === Этап 1: Тесты ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install test dependencies
        run: |
          pip install -r mlops/requirements.txt
          pip install pytest

      - name: Run tests
        run: pytest mlops/tests/test_app.py

      # === Этап 2: Сборка Docker-образа ===
      - name: Build Docker image
        run: |
          docker build \
            --file configs/docker/Dockerfile \
            --tag ${{ env.IMAGE_TAG }} \
            .

      # === Этап 3: Подготовка SSH ===
      - name: Setup SSH key
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # === Этап 4: Сохранение и отправка ===
      - name: Save and compress Docker image
        run: |
          docker save ${{ env.IMAGE_TAG }} | gzip > /tmp/${{ env.ARCHIVE_NAME }}.tar.gz

      - name: Copy image to server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          USER: ${{ secrets.SERVER_USER }}
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            /tmp/${{ env.ARCHIVE_NAME }}.tar.gz \
            $USER@$SERVER_IP:/tmp/

      # === Этап 5: Запуск на сервере ===
      - name: Load image and run container on server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          USER: ${{ secrets.SERVER_USER }}
          IMAGE_NAME: ${{ env.IMAGE_TAG }}
          CONTAINER_NAME: ${{ env.APP_NAME }}
          ARCHIVE_NAME: ${{ env.ARCHIVE_NAME }}
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "$USER@$SERVER_IP" "
            set -e
            docker load < /tmp/$ARCHIVE_NAME.tar.gz
            docker stop $CONTAINER_NAME 2>/dev/null || true
            docker rm $CONTAINER_NAME 2>/dev/null || true
            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              -p 8000:8000 \
              $IMAGE_NAME
            rm -f /tmp/$ARCHIVE_NAME.tar.gz
          "

      - name: Cleanup
        run: echo "✅ Deployed ${{ env.IMAGE_TAG }} at $(date)"